<!doctype html>
<html lang="ja">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>日付計算</title>
  <style>
    :root {
      --bg: #f7fbff;
      --card: rgba(255, 255, 255, 0.75);
      --text: rgba(16, 24, 40, 0.92);
      --muted: rgba(16, 24, 40, 0.68);
      --line: rgba(16, 24, 40, 0.10);

      --accent1: #5eead4;
      --accent2: #93c5fd;
      --accent3: #fbcfe8;

      --danger: #f87171;
    }

    * {
      box-sizing: border-box;
    }

    /* 画面全体で“ダブルタップ拡大”を抑える */
    html,
    body {
      touch-action: manipulation;
    }

    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto,
        "Hiragino Sans", "Hiragino Kaku Gothic ProN", "Noto Sans JP",
        "Yu Gothic", "Meiryo", sans-serif;
      color: var(--text);
      background: #f4cdcd;
      min-height: 100vh;
      line-height: 1.55;
      overflow-x: hidden;
    }

    .wrap {
      max-width: 980px;
      margin: 0 auto;
      padding: 24px 16px 60px;
    }

    header {
      margin: 14px 0 22px;
    }

    h1 {
      font-size: clamp(22px, 3.3vw, 32px);
      margin: 0 0 10px;
      letter-spacing: .02em;
    }

    .sub {
      margin: 0;
      color: var(--muted);
      font-size: 14px;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
      margin-top: 16px;
    }

    .card {
      border: 0;
      background: #F0F4F8;
      border-radius: 18px;
      padding: 22px 20px 20px;
      backdrop-filter: blur(12px);
      box-shadow:
        0 10px 25px rgba(16, 24, 40, 0.06),
        0 1px 0 rgba(255, 255, 255, 0.60) inset;
    }

    .row {
      display: grid;
      gap: 12px;
      margin: 0 0 18px;
    }

    .row:last-of-type {
      margin-bottom: 10px;
    }

    label {
      font-size: 13px;
      color: var(--muted);
      margin-top: 2px;
    }

    /* 入力欄とボタンの高さを揃える */
    input[type="date"],
    input[type="number"],
    button {
      height: 48px;
      padding: 0 12px;
      box-sizing: border-box;
      line-height: normal;
      /* inputにline-height:48pxを当てると崩れる端末があるため */
    }

    /* input */
    input[type="date"],
    input[type="number"] {
      width: 100%;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(255, 255, 255, 0.70);
      color: var(--text);
      outline: none;
      font-size: 16px;
    }

    input[type="date"]:focus,
    input[type="number"]:focus {
      border-color: rgba(2, 132, 199, 0.45);
      box-shadow: 0 0 0 4px rgba(147, 197, 253, 0.22);
    }

    /* iOSでdate inputが横に暴れるのを抑える */
    #baseDate {
      min-width: 0;
      max-width: 100%;
      -webkit-appearance: none;
      appearance: none;
    }

    #baseDate::-webkit-date-and-time-value {
      width: 100%;
    }

    /* 横並び（入力 + ボタン群） */
    .days-wrapper {
      display: flex;
      gap: 10px;
      align-items: stretch;
    }

    .days-wrapper input {
      flex: 1;
    }

    /* ボタン共通 */
    button {
      border: 1px solid var(--line);
      background: rgba(255, 255, 255, 0.70);
      color: var(--text);
      border-radius: 14px;
      cursor: pointer;
      font-size: 14px;
      transition: transform .05s ease, box-shadow .15s ease, background .15s ease;
      user-select: none;
      box-shadow: 0 8px 16px rgba(16, 24, 40, 0.06);
    }

    button:hover:not(.sign-btn) {
      background: rgba(255, 255, 255, 0.85);
      box-shadow: 0 12px 22px rgba(16, 24, 40, 0.08);
    }

    button:active {
      transform: translateY(1px);
    }

    /* リセット（控えめ） */
    .reset-btn {
      font-size: 13px;
      opacity: 0.7;
      background: transparent;
    }

    .reset-btn:hover {
      opacity: 1;
      background: rgba(253, 164, 175, 0.08);
    }

    /* danger（リセット用の薄赤） */
    button.danger {
      background: rgba(248, 113, 113, 0.10);
      border-color: rgba(248, 113, 113, 0.25);
    }

    button.danger:hover {
      background: rgba(248, 113, 113, 0.14);
    }

    /* 基準日ラベル行 */
    .row-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    /* ラベル行の右側ボタン（高さが小さく見える問題を避けるため） */
    .reset-inline {
      height: 32px;
      /* 見た目の“控えめ”を維持 */
      padding: 0 12px;
      line-height: 32px;
      /* ボタン内の文字を中央に */
    }

    /* ＋/−ボタン */
    .step-btn {
      min-width: 44px;
      border-radius: 12px;
      font-weight: 800;
      line-height: 1;
    }

    /* 正負切替ボタン */
    .sign-btn {
      min-width: 48px;
      border-radius: 12px;
      font-weight: 700;
      background: linear-gradient(135deg,
          rgba(94, 234, 212, 0.4),
          rgba(147, 197, 253, 0.4));
    }

    .sign-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    /* 下段（正負切替 + 初日を数える） */
    .below-row {
      display: flex;
      gap: 10px;
      align-items: stretch;
      justify-content: flex-start;
      margin-top: 10px;
    }

    .below-row>* {
      flex: 1;
      min-width: 0;
    }

    /* 初日を数える（チェック） */
    .inline {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(0, 0, 0, .12);
    }

    .inline-compact {
      padding: 8px 10px;
    }

    .below-row label.inline {
      width: 100%;
      justify-content: flex-start;
    }

    .inline input[type="checkbox"] {
      transform: translateY(1px);
    }

    /* 結果エリア */
    .btns {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 16px;
    }

    .pill {
      border: 1px solid var(--line);
      background: rgba(255, 255, 255, 0.70);
      padding: 12px 22px;
      border-radius: 999px;
      color: var(--muted);
    }

    #resultPill {
      margin-left: auto;
    }

    .pill .muted {
      margin: 0 0 6px;
    }

    .big {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: .02em;
      overflow-wrap: anywhere;
    }

    .muted {
      color: var(--muted);
      font-size: 13px;
      margin: 0;
    }

    /* エラー/OK */
    .ok {
      color: var(--accent2);
      font-weight: 600;
      font-size: 13px;
      min-height: 18px;
      line-height: 1.35;
    }

    .err {
      color: var(--danger);
      font-weight: 600;
      font-size: 13px;
      min-height: 18px;
      line-height: 1.35;
    }

    /* 曜日色 */
    .saturday {
      color: #60a5fa;
    }

    .sunday {
      color: #f87171;
    }

    /* スマホ調整 */
    @media (max-width: 480px) {
      .card {
        padding: 18px 16px 16px;
      }

      .row {
        margin-bottom: 16px;
      }

      .pill {
        padding: 10px 30px;
      }

      .below-row {
        justify-content: space-between;
      }

      /* スマホは少しだけ押しやすく */
      .reset-inline {
        height: 32px;
        line-height: 32px;
      }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <h1>日付計算</h1>
      <p class="sub">基準日から指定した日数を足し引きして日付を計算します。</p>
    </header>

    <div class="grid">
      <section class="card" aria-label="入力">
        <div class="row">
          <div class="row-head">
            <label>基準日</label>
            <button class="danger reset-btn reset-inline" id="resetBtn" type="button">リセット</button>
          </div>

          <div class="days-wrapper">
            <input id="baseDate" type="date" />
            <button type="button" class="step-btn" id="basePlusBtn">＋</button>
            <button type="button" class="step-btn" id="baseMinusBtn">−</button>
          </div>
        </div>

        <div class="row">
          <label>日数の差（マイナス値も入力可能）</label>

          <div class="days-wrapper">
            <input id="days" type="number" inputmode="numeric" placeholder="" />
            <button type="button" class="step-btn" id="plusBtn">＋</button>
            <button type="button" class="step-btn" id="minusBtn">−</button>
          </div>

          <div class="below-row">
            <button type="button" class="sign-btn" id="toggleSignBtn">正負切替</button>

            <label class="inline inline-compact" for="includeStart">
              <input id="includeStart" type="checkbox" />
              初日を数える
            </label>
          </div>
        </div>

        <div class="btns">
          <div class="pill" id="resultPill" style="margin-top:0;">
            <p class="muted">計算結果</p>
            <span class="big" id="resultDate">----/--/--（-）</span>
          </div>
        </div>

        <div style="margin-top:12px">
          <div class="err" id="errorText"></div>
          <div class="ok" id="okText"></div>
        </div>
      </section>
    </div>
  </div>

  <script>
    // =========================
    // JS（最適化版）
    // =========================

    // 参照（id直取り）
    const baseDateEl = document.getElementById('baseDate');
    const daysEl = document.getElementById('days');
    const includeStartEl = document.getElementById('includeStart');

    const resultDateEl = document.getElementById('resultDate');
    const errorTextEl = document.getElementById('errorText');
    const okTextEl = document.getElementById('okText');

    const resetBtn = document.getElementById('resetBtn');
    const toggleSignBtn = document.getElementById('toggleSignBtn');

    // ボタン
    const plusBtn = document.getElementById('plusBtn');
    const minusBtn = document.getElementById('minusBtn');
    const basePlusBtn = document.getElementById('basePlusBtn');
    const baseMinusBtn = document.getElementById('baseMinusBtn');

    // 定数
    const WEEK = ['日', '月', '火', '水', '木', '金', '土'];
    const EMPTY_RESULT = '----/--/--（-）';
    const MAX_DIGITS = 4;

    // ==============
    // 日付/表示系
    // ==============
    function setToday() {
      baseDateEl.value = toISO(new Date());
    }

    // "YYYY-MM-DD" を local 12:00 にする（ズレ事故を避ける）
    function parseYMDToLocalNoon(ymd) {
      const [y, m, d] = ymd.split('-').map(Number);
      return new Date(y, m - 1, d, 12, 0, 0, 0);
    }

    function toISO(dateObj) {
      const y = dateObj.getFullYear();
      const m = String(dateObj.getMonth() + 1).padStart(2, '0');
      const d = String(dateObj.getDate()).padStart(2, '0');
      return `${y}-${m}-${d}`;
    }

    function formatJP(dateObj) {
      const y = dateObj.getFullYear();
      const m = String(dateObj.getMonth() + 1).padStart(2, '0');
      const d = String(dateObj.getDate()).padStart(2, '0');
      const dayIndex = dateObj.getDay();
      const w = WEEK[dayIndex];

      const cls = dayIndex === 0 ? 'sunday' : dayIndex === 6 ? 'saturday' : '';
      return `${y}/${m}/${d}（<span class="${cls}">${w}</span>）`;
    }

    // ==============
    // UI補助
    // ==============
    function clearMessages() {
      errorTextEl.textContent = '';
      okTextEl.textContent = '';
    }

    function showError(msg) {
      errorTextEl.textContent = msg;
      okTextEl.textContent = '';
    }

    function setEmptyResult() {
      resultDateEl.textContent = EMPTY_RESULT;
    }

    function updateSignButtonState() {
      const n = Number(daysEl.value);
      toggleSignBtn.disabled = !daysEl.value || !Number.isFinite(n) || n === 0;
    }

    // ==============
    // 入力正規化
    // ==============
    function normalizeDaysInput() {
      let raw = String(daysEl.value ?? '').trim();

      // 入力途中の「-」「+」はそのまま許す（結果は空表示）
      if (raw === '-' || raw === '+') return raw;

      // 符号
      const sign = raw.startsWith('-') ? '-' : '';

      // 数字だけ抜く
      let digits = raw.replace(/[^0-9]/g, '');

      // 先頭0を整理（"0002" → "2"）
      digits = digits.replace(/^0+(?=\d)/, '');

      // 桁制限
      if (digits.length > MAX_DIGITS) digits = digits.slice(0, MAX_DIGITS);

      const normalized = sign + digits;
      daysEl.value = normalized;
      return normalized;
    }

    // ==============
    // 計算ロジック
    // ==============
    function calcAddDays(days, includeStart) {
      if (!includeStart) return days;

      // 初日を数える：±1は当日、それ以外は1日ぶん寄せる
      if (days === 1 || days === -1) return 0;
      if (days > 1) return days - 1;
      if (days < -1) return days + 1;
      return 0; // 0
    }

    function calculate() {
      clearMessages();

      const baseYMD = baseDateEl.value;
      if (!baseYMD) {
        showError('基準日を入力してください。');
        setEmptyResult();
        updateSignButtonState();
        return;
      }

      const daysStr = String(daysEl.value ?? '').trim();

      // 空/入力途中は計算しない（エラーも出さない）
      if (daysStr === '' || daysStr === '-' || daysStr === '+') {
        setEmptyResult();
        updateSignButtonState();
        return;
      }

      const days = Number(daysStr);
      if (!Number.isFinite(days)) {
        showError('日数を数値で入力してください。');
        setEmptyResult();
        updateSignButtonState();
        return;
      }

      const addDays = calcAddDays(days, includeStartEl.checked);

      const base = parseYMDToLocalNoon(baseYMD);
      base.setDate(base.getDate() + addDays);

      resultDateEl.innerHTML = formatJP(base);
      updateSignButtonState();
    }

    // ==============
    // ボタン操作
    // ==============
    function stepDays(delta) {
      const normalized = normalizeDaysInput();

      // 空/入力途中なら 0 からスタート
      let n = 0;
      if (normalized !== '' && normalized !== '-' && normalized !== '+') {
        n = Number(normalized);
        if (!Number.isFinite(n)) n = 0;
      }

      daysEl.value = String(n + delta);
      calculate();
    }

    function toggleSign() {
      const v = String(daysEl.value ?? '').trim();
      const n = Number(v);
      if (!v || !Number.isFinite(n) || n === 0) return;

      daysEl.value = v.startsWith('-') ? v.slice(1) : '-' + v;
      calculate();
    }

    function stepBaseDate(deltaDays) {
      if (!baseDateEl.value) setToday();

      const base = parseYMDToLocalNoon(baseDateEl.value);
      base.setDate(base.getDate() + deltaDays);
      baseDateEl.value = toISO(base);

      calculate();
    }

    function resetAll() {
      includeStartEl.checked = false;
      setToday();
      daysEl.value = '';
      clearMessages();
      setEmptyResult();
      updateSignButtonState();
      // daysが空なので calculate() は呼ばなくてOK（無駄を減らす）
    }

    // ==============
    // イベント登録
    // ==============
    plusBtn.addEventListener('click', () => stepDays(1));
    minusBtn.addEventListener('click', () => stepDays(-1));
    basePlusBtn.addEventListener('click', () => stepBaseDate(1));
    baseMinusBtn.addEventListener('click', () => stepBaseDate(-1));
    toggleSignBtn.addEventListener('click', toggleSign);
    resetBtn.addEventListener('click', resetAll);

    baseDateEl.addEventListener('change', calculate);
    includeStartEl.addEventListener('change', calculate);

    daysEl.addEventListener('input', () => {
      const normalized = normalizeDaysInput();
      updateSignButtonState();

      if (normalized === '' || normalized === '-' || normalized === '+') {
        clearMessages();
        setEmptyResult();
        return;
      }
      calculate();
    });

    // 初期化
    setToday();
    daysEl.value = '';
    setEmptyResult();
    updateSignButtonState();
  </script>
</body>

</html>
